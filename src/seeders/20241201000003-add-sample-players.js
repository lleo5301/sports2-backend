'use strict';
const bcrypt = require('bcryptjs');

module.exports = {
  up: async (queryInterface, Sequelize) => {
    // Get the first team ID for association
    const teams = await queryInterface.sequelize.query(
      'SELECT id FROM teams LIMIT 1',
      { type: Sequelize.QueryTypes.SELECT }
    );

    const teamId = teams[0]?.id || 1;
    // Try to use an existing user as creator if available; otherwise leave null to avoid FK errors
    // Ensure a default user exists to satisfy FK constraints on created_by
    let users = await queryInterface.sequelize.query(
      "SELECT id FROM users WHERE email = 'user@example.com'",
      { type: Sequelize.QueryTypes.SELECT }
    );
    if (users.length === 0) {
      const salt = await bcrypt.genSalt(10);
      const hashedPassword = await bcrypt.hash('password', salt);
      const nowUser = new Date();
      await queryInterface.bulkInsert('users', [{
        email: 'user@example.com',
        password: hashedPassword,
        oauth_provider: 'local',
        oauth_id: null,
        avatar_url: null,
        first_name: 'Demo',
        last_name: 'User',
        role: 'head_coach',
        phone: '+1-555-0123',
        is_active: true,
        last_login: null,
        team_id: teamId,
        created_at: nowUser,
        updated_at: nowUser
      }], {});
      users = await queryInterface.sequelize.query(
        "SELECT id FROM users WHERE email = 'user@example.com'",
        { type: Sequelize.QueryTypes.SELECT }
      );
    }
    const createdBy = users[0].id;
    const now = new Date();

    const players = [
      // Pitchers
      {
        first_name: 'Michael',
        last_name: 'Johnson',
        school_type: 'HS',
        position: 'P',
        height: '6\'2"',
        weight: 185,
        graduation_year: 2025,
        school: 'Westlake High School',
        city: 'Austin',
        state: 'TX',
        batting_avg: 0.285,
        home_runs: 3,
        rbi: 15,
        stolen_bases: 2,
        era: 2.45,
        wins: 8,
        losses: 2,
        strikeouts: 95,
        has_medical_issues: false,
        has_comparison: true,
        status: 'active',
        team_id: teamId,
        created_by: createdBy,
        created_at: now,
        updated_at: now
      },
      {
        first_name: 'David',
        last_name: 'Martinez',
        school_type: 'HS',
        position: 'P',
        height: '6\'0"',
        weight: 175,
        graduation_year: 2025,
        school: 'Lake Travis High School',
        city: 'Austin',
        state: 'TX',
        batting_avg: 0.220,
        home_runs: 1,
        rbi: 8,
        stolen_bases: 0,
        era: 3.12,
        wins: 6,
        losses: 3,
        strikeouts: 78,
        has_medical_issues: false,
        has_comparison: false,
        status: 'active',
        team_id: teamId,
        created_by: createdBy,
        created_at: now,
        updated_at: now
      },
      // Catchers
      {
        first_name: 'James',
        last_name: 'Wilson',
        school_type: 'HS',
        position: 'C',
        height: '5\'11"',
        weight: 190,
        graduation_year: 2025,
        school: 'Vandegrift High School',
        city: 'Austin',
        state: 'TX',
        batting_avg: 0.320,
        home_runs: 5,
        rbi: 28,
        stolen_bases: 3,
        era: null,
        wins: null,
        losses: null,
        strikeouts: null,
        has_medical_issues: false,
        has_comparison: true,
        status: 'active',
        team_id: teamId,
        created_by: createdBy,
        created_at: now,
        updated_at: now
      },
      // Infielders
      {
        first_name: 'Robert',
        last_name: 'Davis',
        school_type: 'HS',
        position: 'SS',
        height: '6\'1"',
        weight: 180,
        graduation_year: 2025,
        school: 'Westwood High School',
        city: 'Austin',
        state: 'TX',
        batting_avg: 0.345,
        home_runs: 7,
        rbi: 32,
        stolen_bases: 12,
        era: null,
        wins: null,
        losses: null,
        strikeouts: null,
        has_medical_issues: false,
        has_comparison: true,
        status: 'active',
        team_id: teamId,
        created_by: createdBy,
        created_at: now,
        updated_at: now
      },
      {
        first_name: 'Christopher',
        last_name: 'Brown',
        school_type: 'HS',
        position: '2B',
        height: '5\'10"',
        weight: 170,
        graduation_year: 2025,
        school: 'McCallum High School',
        city: 'Austin',
        state: 'TX',
        batting_avg: 0.298,
        home_runs: 2,
        rbi: 18,
        stolen_bases: 8,
        era: null,
        wins: null,
        losses: null,
        strikeouts: null,
        has_medical_issues: false,
        has_comparison: false,
        status: 'active',
        team_id: teamId,
        created_by: createdBy,
        created_at: now,
        updated_at: now
      },
      {
        first_name: 'William',
        last_name: 'Taylor',
        school_type: 'HS',
        position: '3B',
        height: '6\'0"',
        weight: 185,
        graduation_year: 2025,
        school: 'Anderson High School',
        city: 'Austin',
        state: 'TX',
        batting_avg: 0.312,
        home_runs: 6,
        rbi: 25,
        stolen_bases: 5,
        era: null,
        wins: null,
        losses: null,
        strikeouts: null,
        has_medical_issues: false,
        has_comparison: true,
        status: 'active',
        team_id: teamId,
        created_by: createdBy,
        created_at: now,
        updated_at: now
      },
      {
        first_name: 'Thomas',
        last_name: 'Anderson',
        school_type: 'HS',
        position: '1B',
        height: '6\'3"',
        weight: 200,
        graduation_year: 2025,
        school: 'Bowie High School',
        city: 'Austin',
        state: 'TX',
        batting_avg: 0.335,
        home_runs: 9,
        rbi: 38,
        stolen_bases: 1,
        era: null,
        wins: null,
        losses: null,
        strikeouts: null,
        has_medical_issues: false,
        has_comparison: true,
        status: 'active',
        team_id: teamId,
        created_by: createdBy,
        created_at: now,
        updated_at: now
      },
      // Outfielders
      {
        first_name: 'Joseph',
        last_name: 'Garcia',
        school_type: 'HS',
        position: 'CF',
        height: '6\'0"',
        weight: 175,
        graduation_year: 2025,
        school: 'Cedar Park High School',
        city: 'Cedar Park',
        state: 'TX',
        batting_avg: 0.328,
        home_runs: 4,
        rbi: 22,
        stolen_bases: 15,
        era: null,
        wins: null,
        losses: null,
        strikeouts: null,
        has_medical_issues: false,
        has_comparison: true,
        status: 'active',
        team_id: teamId,
        created_by: createdBy,
        created_at: now,
        updated_at: now
      },
      {
        first_name: 'Daniel',
        last_name: 'Rodriguez',
        school_type: 'HS',
        position: 'LF',
        height: '5\'11"',
        weight: 180,
        graduation_year: 2025,
        school: 'Leander High School',
        city: 'Leander',
        state: 'TX',
        batting_avg: 0.295,
        home_runs: 3,
        rbi: 19,
        stolen_bases: 7,
        era: null,
        wins: null,
        losses: null,
        strikeouts: null,
        has_medical_issues: false,
        has_comparison: false,
        status: 'active',
        team_id: teamId,
        created_by: 1,
        created_at: now,
        updated_at: now
      },
      {
        first_name: 'Matthew',
        last_name: 'Lee',
        school_type: 'HS',
        position: 'RF',
        height: '6\'1"',
        weight: 185,
        graduation_year: 2025,
        school: 'Round Rock High School',
        city: 'Round Rock',
        state: 'TX',
        batting_avg: 0.310,
        home_runs: 5,
        rbi: 24,
        stolen_bases: 6,
        era: null,
        wins: null,
        losses: null,
        strikeouts: null,
        has_medical_issues: false,
        has_comparison: true,
        status: 'active',
        team_id: teamId,
        created_by: 1,
        created_at: now,
        updated_at: now
      }
    ];

    await queryInterface.bulkInsert('players', players, {});
  },

  down: async (queryInterface, _Sequelize) => {
    await queryInterface.bulkDelete('players', null, {});
  }
};
